<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madrasa Manager - Parents Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta name="theme-color" content="#ea580c">
    <style>
        .hide { display: none !important; }
        .fade-in { 
            animation: fadeIn 0.3s ease-in; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        body {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            min-height: 100vh;
        }

        .spinner {
            border: 2px solid #ffedd5;
            border-top: 2px solid #ea580c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-primary {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .status-present { background-color: #dcfce7; color: #166534; }
        .status-late { background-color: #fed7aa; color: #9a3412; }
        .status-absent { background-color: #fecaca; color: #991b1b; }
        .status-leave { background-color: #dbeafe; color: #1e40af; }

        .highlight {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border: 2px solid #ea580c;
            box-shadow: 0 0 0 4px rgba(234, 88, 12, 0.1);
        }

        .task-master-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .task-master-table th {
            background-color: #fff7ed;
            font-weight: 600;
            text-align: center;
            border: 1px solid #fed7aa;
            padding: 12px 8px;
            font-size: 13px;
            position: relative;
            color: #9a3412;
        }

        .task-master-table td {
            border: 1px solid #fed7aa;
            text-align: center;
            padding: 12px 8px;
            background-color: white;
        }

        .task-master-table th:first-child,
        .task-master-table td:first-child {
            text-align: left;
            padding-left: 16px;
            background-color: #fff7ed;
            position: sticky;
            left: 0;
            z-index: 10;
            min-width: 150px;
            font-weight: 500;
            color: #111827;
        }

        .rotated-task-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #9a3412;
            white-space: nowrap;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #fb923c;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .task-checkbox.completed {
            background-color: #ea580c;
            color: white;
        }

        .my-student {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @media (max-width: 640px) {
            .task-master-table th,
            .task-master-table td {
                padding: 8px 4px;
                font-size: 12px;
            }

            .task-master-table th:first-child,
            .task-master-table td:first-child {
                min-width: 120px;
                padding-left: 12px;
            }

            .rotated-task-header {
                height: 80px;
                font-size: 11px;
            }

            .task-checkbox {
                width: 18px;
                height: 18px;
            }
        }

        .password-input {
            font-family: monospace;
            letter-spacing: 2px;
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <!-- Class Selection Screen -->
    <div id="class-selection" class="min-h-screen flex flex-col items-center justify-center px-4">
        <div class="bg-orange-600 w-20 h-20 rounded-full flex items-center justify-center mb-6 shadow-lg card">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
        </div>

        <h1 class="text-3xl font-bold text-gray-900 mb-2">Madrasa Manager</h1>
        <p class="text-gray-600 mb-8 text-center">Parents Portal</p>
        <p class="text-sm text-orange-600 mb-6 text-center">Select your child's class</p>

        <div id="classes-list" class="w-full max-w-md space-y-3">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Student Selection Screen -->
    <div id="student-selection" class="hide min-h-screen flex flex-col items-center justify-center px-4 relative">
        <button id="back-to-classes" class="absolute top-8 left-4 p-3 bg-white rounded-full shadow-lg card">
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <div class="bg-orange-500 w-16 h-16 rounded-full flex items-center justify-center mb-6 shadow-lg">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>

        <h2 class="text-2xl font-bold mb-2 text-gray-900" id="selected-class-name"></h2>
        <p class="text-gray-600 mb-2" id="class-schedule-info"></p>
        <p class="text-sm text-orange-600 mb-8">Select your child</p>

        <div id="students-list" class="w-full max-w-md space-y-3">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hide fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full glass-effect">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h3 id="password-student-name" class="text-xl font-semibold mb-2"></h3>
                <p class="text-gray-600 text-sm">Enter your password to continue</p>
            </div>

            <div class="mb-6">
                <input 
                    type="password" 
                    id="password-input" 
                    placeholder="Enter password" 
                    class="password-input w-full p-4 border-2 border-gray-200 rounded-lg text-lg text-center focus:border-orange-500 focus:outline-none transition-colors"
                    maxlength="10"
                >
            </div>

            <div class="flex gap-3">
                <button id="password-cancel" class="flex-1 bg-gray-200 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="password-submit" class="flex-1 btn-primary text-white py-3 rounded-lg font-medium">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hide">
        <!-- Header -->
        <header class="bg-orange-600 text-white px-4 py-4 sticky top-0 z-40 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold" id="student-display-name"></h1>
                        <p class="text-sm text-orange-100" id="class-display-name"></p>
                    </div>
                </div>
                <button id="logout-btn" class="p-2 rounded-lg bg-orange-700 hover:bg-orange-800 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white shadow-sm sticky top-16 z-30 border-b border-orange-200">
            <div class="flex">
                <button class="tab-btn flex-1 py-4 border-b-2 border-orange-500 font-semibold text-orange-600 transition-all" data-tab="attendance">
                    <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span class="text-xs">Attendance</span>
                </button>
                <button class="tab-btn flex-1 py-4 border-b-2 border-transparent text-gray-600 transition-all" data-tab="daily">
                    <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-xs">Daily Routine</span>
                </button>
                <button class="tab-btn flex-1 py-4 border-b-2 border-transparent text-gray-600 transition-all" data-tab="focus">
                    <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span class="text-xs">Focus</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="p-4 pb-8 min-h-screen bg-gradient-to-b from-orange-50 to-white">
            <!-- Attendance Tab -->
            <div id="attendance-tab" class="tab-content">
                <!-- Today's Overview -->
                <div class="card p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-lg text-gray-900">Today's Attendance</h3>
                        <span id="attendance-date" class="text-sm text-gray-600"></span>
                    </div>
                    <p class="text-sm text-gray-600" id="attendance-time"></p>
                    <div id="friday-notice" class="mt-3 p-3 bg-blue-50 rounded-lg text-center text-blue-800 font-medium hide">
                        üìÖ Friday - Weekly Leave Day
                    </div>
                </div>

                <!-- My Child's Attendance (Highlighted) -->
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        <p class="text-sm font-medium text-gray-700">Your Child</p>
                    </div>
                    <div id="my-student-attendance" class="card p-4 highlight"></div>
                </div>

                <!-- All Students Attendance -->
                <div>
                    <p class="text-sm font-medium text-gray-700 mb-2">Class Attendance</p>
                    <div id="all-students-attendance" class="space-y-2"></div>
                </div>
            </div>

            <!-- Daily Routine Tab -->
            <div id="daily-tab" class="tab-content hide">
                <div class="card p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="font-semibold text-lg text-gray-900">Daily Routine Tasks</h3>
                    </div>
                    <p class="text-sm text-gray-600">Track daily task completion for all students</p>
                </div>

                <div id="daily-tasks-container" class="card overflow-x-auto">
                    <div class="p-6">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Focus Tab -->
            <div id="focus-tab" class="tab-content hide">
                <div class="card p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <h3 class="font-semibold text-lg text-gray-900">Focus Tasks</h3>
                    </div>
                    <p class="text-sm text-gray-600">Personal focus goals for your child</p>
                </div>

                <div id="focus-tasks-container" class="card overflow-x-auto">
                    <div class="p-6">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-orange-600 flex items-center justify-center z-50 hide">
        <div class="text-center">
            <div class="spinner border-white border-t-orange-300 mb-4"></div>
            <p class="text-white font-medium">Loading...</p>
        </div>
    </div>

    <script>
const SUPABASE_URL = 'https://oczzftqfkcpwnhylmvsd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jenpmdHFma2Nwd25oeWxtdnNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzY3MTIsImV4cCI6MjA3NTcxMjcxMn0.6oRz7LPEq0Z3k_lbz60l9iIs_9IwgasApWA85awsoxE';

class ParentsApp {
    constructor() {
        this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        this.selectedClass = null;
        this.selectedStudent = null;
        this.currentTab = 'attendance';
        this.init();
    }

    async init() {
        this.setupEventListeners();
        await this.loadClasses();
    }

    setupEventListeners() {
        // Navigation
        document.getElementById('back-to-classes').addEventListener('click', () => this.showClassSelection());

        // Password modal
        document.getElementById('password-cancel').addEventListener('click', () => this.hidePasswordModal());
        document.getElementById('password-submit').addEventListener('click', () => this.verifyPassword());
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.verifyPassword();
        });

        // Main app
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
        });
    }

    showLoading(show = true) {
        document.getElementById('loading-screen').classList.toggle('hide', !show);
    }

    async loadClasses() {
        const classList = document.getElementById('classes-list');
        classList.innerHTML = '<div class="spinner"></div>';

        try {
            const { data: classes, error } = await this.supabase
                .from('classes')
                .select('*')
                .order('name');

            if (error) throw error;

            classList.innerHTML = '';

            if (!classes || classes.length === 0) {
                classList.innerHTML = `
                    <div class="card p-6 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-2m-2 0H7m14 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v10m8 0V9a2 2 0 012 2v8a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No classes available</p>
                        <p class="text-sm mt-1">Please contact your administrator</p>
                    </div>
                `;
                return;
            }

            for (const cls of classes) {
                const { count } = await this.supabase
                    .from('students')
                    .select('*', { count: 'exact', head: true })
                    .eq('class_id', cls.id);

                const div = document.createElement('div');
                div.className = 'card p-4 cursor-pointer hover:shadow-lg transition-all';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-2m-2 0H7m14 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v10m8 0V9a2 2 0 012 2v8a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg text-gray-900">${cls.name}</h3>
                                <p class="text-sm text-gray-600">${count || 0} students</p>
                                <p class="text-xs text-orange-600">${cls.start_time} - ${cls.end_time}</p>
                            </div>
                        </div>
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                `;
                div.addEventListener('click', () => this.selectClass(cls));
                classList.appendChild(div);
            }

        } catch (error) {
            console.error('Error loading classes:', error);
            classList.innerHTML = `
                <div class="card p-6 text-center text-red-500">
                    <p>Error loading classes</p>
                    <button onclick="location.reload()" class="mt-2 text-sm text-blue-600 underline">Retry</button>
                </div>
            `;
        }
    }

    async selectClass(cls) {
        this.selectedClass = cls;
        document.getElementById('selected-class-name').textContent = cls.name;
        document.getElementById('class-schedule-info').textContent = `${cls.start_time} - ${cls.end_time}`;

        const studentsList = document.getElementById('students-list');
        studentsList.innerHTML = '<div class="spinner"></div>';

        try {
            const { data: students, error } = await this.supabase
                .from('students')
                .select('*')
                .eq('class_id', cls.id)
                .order('roll_number');

            if (error) throw error;

            studentsList.innerHTML = '';

            if (!students || students.length === 0) {
                studentsList.innerHTML = `
                    <div class="card p-6 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <p>No students in this class</p>
                    </div>
                `;
                this.showStudentSelection();
                return;
            }

            students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'card p-4 cursor-pointer hover:shadow-lg transition-all';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${student.name}</h3>
                                <p class="text-sm text-gray-600">Roll No: ${student.roll_number}</p>
                                ${student.password ? 
                                    '<p class="text-xs text-green-600">üîê Password protected</p>' : 
                                    '<p class="text-xs text-orange-600">‚ö†Ô∏è No password set</p>'
                                }
                            </div>
                        </div>
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                `;
                div.addEventListener('click', () => this.showPasswordModal(student));
                studentsList.appendChild(div);
            });

            this.showStudentSelection();

        } catch (error) {
            console.error('Error loading students:', error);
            studentsList.innerHTML = `
                <div class="card p-6 text-center text-red-500">
                    <p>Error loading students</p>
                    <button onclick="this.selectClass(this.selectedClass)" class="mt-2 text-sm text-blue-600 underline">Retry</button>
                </div>
            `;
            this.showStudentSelection();
        }
    }

    showClassSelection() {
        document.getElementById('class-selection').classList.remove('hide');
        document.getElementById('student-selection').classList.add('hide');
        document.getElementById('main-app').classList.add('hide');
        this.selectedClass = null;
        this.selectedStudent = null;
    }

    showStudentSelection() {
        document.getElementById('class-selection').classList.add('hide');
        document.getElementById('student-selection').classList.remove('hide');
        document.getElementById('main-app').classList.add('hide');
    }

    showPasswordModal(student) {
        this.selectedStudent = student;
        document.getElementById('password-student-name').textContent = student.name;
        document.getElementById('password-input').value = '';
        document.getElementById('password-modal').classList.remove('hide');

        // Focus input after animation
        setTimeout(() => {
            document.getElementById('password-input').focus();
        }, 100);
    }

    hidePasswordModal() {
        document.getElementById('password-modal').classList.add('hide');
        this.selectedStudent = null;
    }

    async verifyPassword() {
        const password = document.getElementById('password-input').value.trim();

        if (!password) {
            this.showAlert('Please enter a password');
            return;
        }

        // If student has no password set, allow any password
        if (!this.selectedStudent.password) {
            this.hidePasswordModal();
            this.showMainApp();
            return;
        }

        // Check password
        if (password !== this.selectedStudent.password) {
            this.showAlert('Incorrect password. Please try again.');
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
            return;
        }

        this.hidePasswordModal();
        this.showMainApp();
    }

    showAlert(message) {
        // Simple alert for now - could be enhanced with custom modal
        alert(message);
    }

    async showMainApp() {
        this.showLoading(true);

        document.getElementById('class-selection').classList.add('hide');
        document.getElementById('student-selection').classList.add('hide');
        document.getElementById('main-app').classList.remove('hide');

        document.getElementById('student-display-name').textContent = this.selectedStudent.name;
        document.getElementById('class-display-name').textContent = this.selectedClass.name;

        await this.switchTab('attendance');

        this.showLoading(false);
    }

    async switchTab(tab) {
        this.currentTab = tab;

        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const isActive = btn.dataset.tab === tab;
            btn.classList.toggle('border-orange-500', isActive);
            btn.classList.toggle('text-orange-600', isActive);
            btn.classList.toggle('font-semibold', isActive);
            btn.classList.toggle('border-transparent', !isActive);
            btn.classList.toggle('text-gray-600', !isActive);
        });

        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hide');
        });

        // Show selected tab
        document.getElementById(`${tab}-tab`).classList.remove('hide');

        // Load content
        switch(tab) {
            case 'attendance': 
                await this.loadAttendance(); 
                break;
            case 'daily': 
                await this.loadDailyTasks(); 
                break;
            case 'focus': 
                await this.loadFocusTasks(); 
                break;
        }
    }

    async loadAttendance() {
        const today = new Date().toISOString().split('T')[0];
        const todayDate = new Date();
        const isFriday = todayDate.getDay() === 5;

        // Update header info
        document.getElementById('attendance-date').textContent = new Date().toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric' 
        });
        document.getElementById('attendance-time').textContent = 
            `Class: ${this.selectedClass.start_time} - ${this.selectedClass.end_time}`;

        // Show/hide Friday notice
        document.getElementById('friday-notice').classList.toggle('hide', !isFriday);

        if (isFriday) {
            document.getElementById('my-student-attendance').innerHTML = `
                <div class="text-center py-4">
                    <svg class="w-12 h-12 mx-auto mb-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-blue-800 font-medium">Weekly Leave Day</p>
                </div>
            `;
            document.getElementById('all-students-attendance').innerHTML = '';
            return;
        }

        try {
            const { data: students } = await this.supabase
                .from('students')
                .select('*')
                .eq('class_id', this.selectedClass.id)
                .order('roll_number');

            const { data: attendance } = await this.supabase
                .from('attendance')
                .select('*')
                .eq('class_id', this.selectedClass.id)
                .eq('date', today);

            // My student's attendance
            const myAttendance = attendance?.find(a => a.student_id === this.selectedStudent.id);
            const myContainer = document.getElementById('my-student-attendance');

            if (myAttendance) {
                const statusClass = `status-${myAttendance.status}`;
                const time = myAttendance.status !== 'absent' 
                    ? new Date(myAttendance.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                    : '';

                myContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg">${this.selectedStudent.name}</h4>
                                <p class="text-sm text-gray-600">Roll: ${this.selectedStudent.roll_number}</p>
                                ${time ? `<p class="text-sm text-gray-600 mt-1">‚è∞ Marked at ${time}</p>` : ''}
                            </div>
                        </div>
                        <span class="${statusClass} px-4 py-2 rounded-full text-sm font-medium">
                            ${myAttendance.status.toUpperCase()}
                        </span>
                    </div>
                `;
            } else {
                myContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg">${this.selectedStudent.name}</h4>
                                <p class="text-sm text-gray-600">Roll: ${this.selectedStudent.roll_number}</p>
                            </div>
                        </div>
                        <span class="bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm font-medium">
                            NOT MARKED
                        </span>
                    </div>
                `;
            }

            // All students attendance (excluding my student)
            const allContainer = document.getElementById('all-students-attendance');
            allContainer.innerHTML = '';

            const otherStudents = students?.filter(s => s.id !== this.selectedStudent.id) || [];

            if (otherStudents.length === 0) {
                allContainer.innerHTML = `
                    <div class="card p-4 text-center text-gray-500">
                        <p>Only one student in class</p>
                    </div>
                `;
                return;
            }

            otherStudents.forEach(student => {
                const studentAttendance = attendance?.find(a => a.student_id === student.id);

                const div = document.createElement('div');
                div.className = 'card p-3';

                if (studentAttendance) {
                    const statusClass = `status-${studentAttendance.status}`;
                    const time = studentAttendance.status !== 'absent'
                        ? new Date(studentAttendance.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                        : '';

                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">${student.name}</h4>
                                <p class="text-xs text-gray-600">Roll: ${student.roll_number}</p>
                                ${time ? `<p class="text-xs text-gray-600 mt-1">${time}</p>` : ''}
                            </div>
                            <span class="${statusClass} px-3 py-1 rounded-full text-xs font-medium">
                                ${studentAttendance.status.toUpperCase()}
                            </span>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">${student.name}</h4>
                                <p class="text-xs text-gray-600">Roll: ${student.roll_number}</p>
                            </div>
                            <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-medium">NOT MARKED</span>
                        </div>
                    `;
                }

                allContainer.appendChild(div);
            });

        } catch (error) {
            console.error('Error loading attendance:', error);
            document.getElementById('my-student-attendance').innerHTML = `
                <div class="text-center text-red-500 py-4">
                    <p>Error loading attendance data</p>
                </div>
            `;
        }
    }

    async loadDailyTasks() {
        const container = document.getElementById('daily-tasks-container');
        container.innerHTML = '<div class="p-6"><div class="spinner"></div></div>';

        try {
            const { data: tasks } = await this.supabase
                .from('tasks')
                .select('*')
                .eq('class_id', this.selectedClass.id)
                .eq('type', 'daily')
                .order('created_at');

            const { data: students } = await this.supabase
                .from('students')
                .select('*')
                .eq('class_id', this.selectedClass.id)
                .order('roll_number');

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>No daily tasks created yet</p>
                    </div>
                `;
                return;
            }

            if (!students || students.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">No students in class</div>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const { data: completions } = await this.supabase
                .from('task_completion')
                .select('*')
                .in('task_id', tasks.map(t => t.id))
                .eq('date', today);

            const table = document.createElement('table');
            table.className = 'task-master-table';

            // Header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const studentHeader = document.createElement('th');
            studentHeader.textContent = 'Students';
            headerRow.appendChild(studentHeader);

            tasks.forEach(task => {
                const th = document.createElement('th');
                const div = document.createElement('div');
                div.className = 'rotated-task-header';
                div.textContent = task.title;
                th.appendChild(div);
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');

            students.forEach(student => {
                const row = document.createElement('tr');
                const isMyStudent = student.id === this.selectedStudent.id;

                if (isMyStudent) {
                    row.classList.add('highlight', 'my-student');
                }

                const nameCell = document.createElement('td');
                nameCell.innerHTML = `
                    <div class="flex items-center gap-2">
                        ${isMyStudent ? '<svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>' : ''}
                        <div>
                            <div class="font-medium">${student.name}</div>
                            <div class="text-xs text-gray-600">Roll: ${student.roll_number}</div>
                        </div>
                    </div>
                `;
                row.appendChild(nameCell);

                tasks.forEach(task => {
                    const td = document.createElement('td');
                    const isCompleted = completions?.some(c => 
                        c.task_id === task.id && c.student_id === student.id
                    );

                    const checkbox = document.createElement('div');
                    checkbox.className = `task-checkbox ${isCompleted ? 'completed' : ''}`;

                    if (isCompleted) {
                        checkbox.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                    }

                    td.appendChild(checkbox);
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);

        } catch (error) {
            console.error('Error loading daily tasks:', error);
            container.innerHTML = `
                <div class="p-6 text-center text-red-500">
                    <p>Error loading tasks</p>
                </div>
            `;
        }
    }

    async loadFocusTasks() {
        const container = document.getElementById('focus-tasks-container');
        container.innerHTML = '<div class="p-6"><div class="spinner"></div></div>';

        try {
            const { data: tasks } = await this.supabase
                .from('tasks')
                .select('*')
                .eq('class_id', this.selectedClass.id)
                .eq('type', 'focus')
                .order('created_at');

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <p>No focus tasks created yet</p>
                        <p class="text-sm mt-1">Focus tasks are personal goals set by teachers</p>
                    </div>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const { data: completions } = await this.supabase
                .from('task_completion')
                .select('*')
                .in('task_id', tasks.map(t => t.id))
                .eq('student_id', this.selectedStudent.id)
                .eq('date', today);

            const table = document.createElement('table');
            table.className = 'task-master-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const studentHeader = document.createElement('th');
            studentHeader.textContent = 'Your Tasks';
            headerRow.appendChild(studentHeader);

            tasks.forEach(task => {
                const th = document.createElement('th');
                const div = document.createElement('div');
                div.className = 'rotated-task-header';
                div.textContent = task.title;
                th.appendChild(div);
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const row = document.createElement('tr');
            row.classList.add('highlight', 'my-student');

            const nameCell = document.createElement('td');
            nameCell.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                    <div>
                        <div class="font-medium">${this.selectedStudent.name}</div>
                        <div class="text-xs text-gray-600">Roll: ${this.selectedStudent.roll_number}</div>
                    </div>
                </div>
            `;
            row.appendChild(nameCell);

            tasks.forEach(task => {
                const td = document.createElement('td');
                const isCompleted = completions?.some(c => c.task_id === task.id);

                const checkbox = document.createElement('div');
                checkbox.className = `task-checkbox ${isCompleted ? 'completed' : ''}`;

                if (isCompleted) {
                    checkbox.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                }

                td.appendChild(checkbox);
                row.appendChild(td);
            });

            tbody.appendChild(row);
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);

        } catch (error) {
            console.error('Error loading focus tasks:', error);
            container.innerHTML = `
                <div class="p-6 text-center text-red-500">
                    <p>Error loading focus tasks</p>
                </div>
            `;
        }
    }

    logout() {
        if (confirm('Are you sure you want to logout?')) {
            this.selectedClass = null;
            this.selectedStudent = null;
            this.showClassSelection();
        }
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const parentsApp = new ParentsApp();
});

// Initialize immediately if DOM is already loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        const parentsApp = new ParentsApp();
    });
} else {
    const parentsApp = new ParentsApp();
}
    </script>
</body>
</html>